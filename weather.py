from __future__ import annotations

from typing import Optional
import aiohttp

WEATHER_MESSAGES = {
	'clear': [
		"üåû –ù—É —á—Ç–æ, –∫–ª–∞—Å—Å–∏–∫–∞ ‚Äî —Å–æ–ª–Ω—Ü–µ, –º—è—á, –ø–æ–ª–µ! –ü–ª–æ—Ö–∞—è –ø–æ–≥–æ–¥–∞? –ù–µ, –Ω–µ —Å–ª—ã—à–∞–ª–∏.",
		"üòé –°–æ–ª–Ω—ã—à–∫–æ —Å–≤–µ—Ç–∏—Ç ‚Äî —Ñ—É—Ç–±–æ–ª —Å–∞–º –ø–æ —Å–µ–±–µ –ø—Ä–∞–∑–¥–Ω–∏–∫. –ü–ª–æ—Ö–æ–π –ø–æ–≥–æ–¥—ã –¥–ª—è –Ω–∞—Å –Ω–µ –ø—Ä–∏–¥—É–º–∞–ª–∏!",
		"‚òÄÔ∏è –ù–∞ —É–ª–∏—Ü–µ –∂–∞—Ä–∞, –∞ –Ω–∞ –ø–æ–ª–µ –±—É–¥–µ—Ç –µ—â—ë –≥–æ—Ä—è—á–µ–µ. –ë–µ—Ä—ë–º –≤–æ–¥—É, —Å–æ–ª–Ω—Ü–µ–∑–∞—â–∏—Ç–∫—É –∏ –æ—Ç–ª–∏—á–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π!",
		"üåª –î–ª—è —Ñ—É—Ç–±–æ–ª–∞ —Ç–∞–∫–æ–π –¥–µ–Ω—å ‚Äî –ø—Ä–æ—Å—Ç–æ –º–µ—á—Ç–∞. –ì–ª–∞–≤–Ω–æ–µ –Ω–µ –∑–∞–±—ã—Ç—å —É–ª—ã–±–∫—É!",
		"üåÖ –ü–æ–≥–æ–¥–∞ —Ç–æ–ø—á–∏–∫. –£–∂–µ –æ—â—É—â–∞–µ—à—å –∑–∞–ø–∞—Ö –º—è—á–∞ –≤ –≤–æ–∑–¥—É—Ö–µ?",
	],
	'cloud': [
		"‚òÅÔ∏è –û–±–ª–∞–∫–∞? –¢–∞–∫ –¥–∞–∂–µ —ç–ø–∏—á–Ω–µ–µ –±—É–¥—É—Ç –≥–æ–ª—ã! –í –ø–∞—Å–º—É—Ä–Ω—É—é –ø–æ–≥–æ–¥—É –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç –∂–µ–ª–∞–Ω–∏–µ.",
		"üå¶ –ù–µ–º–Ω–æ–≥–æ –ø–∞—Å–º—É—Ä–Ω–æ, –Ω–æ —Ñ—É—Ç–±–æ–ª–∏—Å—Ç—ã –Ω–µ —Å–∞—Ö–∞—Ä ‚Äî –Ω–µ —Ä–∞—Å—Ç–∞–µ–º —Ç–æ—á–Ω–æ!",
		"‚õÖÔ∏è –î–ª—è —Ñ—É—Ç–±–æ–ª–∞ –Ω–µ –≤–∞–∂–Ω–æ —Å–∫–æ–ª—å–∫–æ –Ω–∞ –Ω–µ–±–µ —Å–æ–ª–Ω—Ü–∞, –≤–∞–∂–Ω–æ –∫—Ç–æ —Å—Ç–æ–∏—Ç —É –≤–æ—Ä–æ—Ç!",
		"üå• –ü–∞—Å–º—É—Ä–Ω–æ, –∑–∞—Ç–æ –º—è—á –±—É–¥–µ—Ç —Ö–æ—Ä–æ—à–æ –≤–∏–¥–Ω–æ ‚Äî –ø–æ–≥–Ω–∞–ª–∏!",
		"‚òÅÔ∏è –ù–µ –±—ã–≤–∞–µ—Ç –ø–ª–æ—Ö–æ–π –ø–æ–≥–æ–¥—ã –¥–ª—è —Ñ—É—Ç–±–æ–ª–∞, –±—ã–≤–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∞!",
	],
	'rain': [
		"‚òîÔ∏è –î–æ–∂–¥—å ‚Äî —ç—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥—É—à –æ—Ç –≤—Å–µ–ª–µ–Ω–Ω–æ–π! –ü–æ–ª–µ –º–æ–∫—Ä–æ–µ, –Ω–∞—Å—Ç—Ä–æ–π ‚Äî –±–æ–µ–≤–æ–π!",
		"üåß –ú–æ–∫—Ä—ã–π –º—è—á ‚Äî –∫—Ä—É—Ç—ã–µ –ø–æ–¥–∫–∞—Ç—ã! –ü–æ–≥–æ–¥–∞ —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –¥—Ä–∞–π–≤–∞.",
		"üå¶ –ù–∞ —É–ª–∏—Ü–µ –¥–æ–∂–¥–∏–∫? –°—á–∏—Ç–∞–π –ø–æ–≤–µ–∑–ª–æ: –º—è—á –ª–µ—Ç–∏—Ç –±—ã—Å—Ç—Ä–µ–µ, —ç–º–æ—Ü–∏–π ‚Äî –±–æ–ª—å—à–µ!",
		"‚òîÔ∏è –ï—Å–ª–∏ –±—ã —Ñ—É—Ç–±–æ–ª–∏—Å—Ç—ã –±–æ—è–ª–∏—Å—å –≤–æ–¥—ã, –º—ã –±—ã —Å–º–æ—Ç—Ä–µ–ª–∏ –¥—Ä—É–≥–∏–µ –≤–∏–¥—ã —Å–ø–æ—Ä—Ç–∞!",
		"üíß –î–æ–∂–¥—å –∑–∞–∫–∞–ª—è–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä —á–µ–º–ø–∏–æ–Ω–æ–≤ ‚Äî –∏ –æ—á–∏—â–∞–µ—Ç –±—É—Ç—Å—ã.",
	],
	'storm': [
		"‚õà –î–∞–∂–µ –º—ã –ø—Ä–∏–∑–Ω–∞—ë–º: –º–æ–ª–Ω–∏—è ‚Äî –Ω–µ –ø–æ–≤–æ–¥ –≥–µ—Ä–æ–π—Å—Ç–≤–æ–≤–∞—Ç—å. –ï—Å–ª–∏ –≥—Ä–æ–∑–∞ ‚Äî —Ñ—É—Ç–±–æ–ª –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º!",
		"üö® –ì—Ä–æ–∑–∞ –Ω–∞ –ø–æ–ª–µ ‚Äî –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –¥–∞–∂–µ –Ω–∞—à —ç–Ω—Ç—É–∑–∏–∞–∑–º –±–µ—Ä—ë—Ç –ø–∞—É–∑—É. –ù–µ —Ä–∏—Å–∫—É–µ–º!",
		"‚ö°Ô∏è –î–ª—è —Ñ—É—Ç–±–æ–ª–∞ –Ω–µ—Ç –ø–ª–æ—Ö–æ–π –ø–æ–≥–æ–¥—ã... –∫—Ä–æ–º–µ —Ç–æ–π, —á—Ç–æ —Å –º–æ–ª–Ω–∏–µ–π. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã!",
		"‚õà –í —Ç–∞–∫—É—é –ø–æ–≥–æ–¥—É –¥–∞–∂–µ VAR —É—Ö–æ–¥–∏—Ç –≤ –æ—Ñ–ª–∞–π–Ω. –ë–µ—Ä–µ–≥–∏—Ç–µ —Å–µ–±—è!",
		"‚ö†Ô∏è –ù–∞–º –≤—Å–µ–º —Ö–æ—á–µ—Ç—Å—è –ø–æ–∏–≥—Ä–∞—Ç—å, –Ω–æ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è —ç–º–æ—Ü–∏–π, –Ω–µ –¥–ª—è –ø–æ–ª—è!",
	],
	'wind': [
		"üí® –í–µ—Ç–µ—Ä? –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∏–≥—Ä–æ–∫ –Ω–∞ –ø–æ–ª–µ! –°—Ç–∞–≤–∏–º –Ω–∞ —Ç–æ—á–Ω—ã–µ –ø–æ–¥–∞—á–∏.",
		"üå™ –ú—è—á –∏–Ω–æ–≥–¥–∞ –±—É–¥–µ—Ç –ø–æ–¥—ã–≥—Ä—ã–≤–∞—Ç—å ‚Äî —Ç—Ä–µ–Ω–∏—Ä—É–µ–º –Ω–∞–≤–µ—Å—ã!",
		"üçÉ –û—Å—Ç—Ä–æ—Ç–∞ –ø–∞—Å–∞ —Å–µ–≥–æ–¥–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è, –≤–µ—Ç–µ—Ä –ø–æ–º–æ–≥–∞–µ—Ç –∞—Ç–∞–∫–µ!",
		"üí® –ö–æ–≥–¥–∞ –≤–µ—Ç–µ—Ä –¥—É–µ—Ç –≤ —Å–ø–∏–Ω—É ‚Äî –ø–æ—Ä–∞ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å–Ω–∏–µ —É–¥–∞—Ä—ã!",
		"ü•Ö –ì–ª–∞–≤–Ω–æ–µ, —á—Ç–æ–±—ã –≤–æ—Ä–æ—Ç–∞ –Ω–µ —É–ª–µ—Ç–µ–ª–∏ ‚Äî –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞!",
	],
	'snow': [
		"‚ùÑÔ∏è –°–Ω–µ–≥ —É–∫—Ä–∞—Å–∏—Ç –º–∞—Ç—á, –∞ –ø–∞—Ä—É –≥–æ–ª–æ–≤ –æ—Ç —Ä–∞–∑–æ–≥—Ä–µ–≤–∞ —Ç–æ–ª—å–∫–æ –ø–ª—é—Å!",
		"‚òÉÔ∏è –°—É–≥—Ä–æ–±—ã? –ó–Ω–∞—á–∏—Ç –ø–æ—Ä–∞ —Å—ã–≥—Ä–∞—Ç—å ‚Äú–ª–µ–¥—è–Ω–æ–π —Ñ–∏–Ω–∞–ª‚Äù!",
		"üå® –î–∞–∂–µ —Å–Ω–µ–≥ ‚Äî –Ω–µ –ø–æ–≤–æ–¥ –æ—Ç–º–µ–Ω—è—Ç—å —Ñ—É—Ç–±–æ–ª. –ó–∞–º–µ—Ä–∑–∞—é—Ç —Ç–æ–ª—å–∫–æ –±–æ–ª–µ–ª—å—â–∏–∫–∏!",
		"‚ùÑÔ∏è –ë–µ–ª–æ–µ –ø–æ–ª–µ ‚Äî –±–æ–ª—å—à–µ –ø–µ—Ä—á–∞—Ç–æ–∫, –±–æ–ª—å—à–µ —ç–º–æ—Ü–∏–π, —Ç–æ—Ç –∂–µ —Ñ—É—Ç–±–æ–ª!",
		"üß§ –ú–æ—Ä–æ–∑ –∏ —Å–æ–ª–Ω—Ü–µ ‚Äî –ø–æ —Ñ—É—Ç–±–æ–ª—å–Ω–æ–º—É —Ç–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç—É —Å–æ—á–µ—Ç–∞—é—Ç—Å—è –∏–¥–µ–∞–ª—å–Ω–æ!",
	],
	'extreme': [
		"üö® –õ–∏–≤–µ–Ω—å –∏ –≤–µ—Ç–µ—Ä —Å–µ–≥–æ–¥–Ω—è —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ—Ö –Ω–∞ –ø–æ–ª–µ. –î–∞–∂–µ –º—ã —Å–æ–≤–µ—Ç—É–µ–º –æ—Å—Ç–∞—Ç—å—Å—è –¥–æ–º–∞!",
		"üåÄ –¢–∞–∫–æ–π —à—Ç–æ—Ä–º –Ω–µ –≤—ã–¥–µ—Ä–∂–∏—Ç –¥–∞–∂–µ —Å—É–¥—å—è ‚Äî —Ñ—É—Ç–±–æ–ª –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è!",
		"üåä ‚Äú–î–ª—è —Ñ—É—Ç–±–æ–ª–∞ –Ω–µ—Ç –ø–ª–æ—Ö–æ–π –ø–æ–≥–æ–¥—ã‚Äù –∏–Ω–æ–≥–¥–∞ —Ç—Ä–µ–±—É–µ—Ç –∑–¥—Ä–∞–≤–æ–≥–æ —Å–º—ã—Å–ª–∞. –°–¥–µ–ª–∞–µ–º –ø–∞—É–∑—É!",
		"üö© –°–µ–≥–æ–¥–Ω—è –Ω–∞ –ø–æ–ª–µ –º–æ–∂–µ—Ç —É–Ω–µ—Å—Ç–∏ –¥–∞–∂–µ –∫–∞–ø–∏—Ç–∞–Ω–æ–≤ ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ —É—Å—Ç—Ä–æ–∏—Ç—å —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä –¥–æ–º–∞!",
		"üõë –ó–∞ –æ–∫–Ω–æ–º –∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å, –∞ –º—ã —Å–ª–∏—à–∫–æ–º –ª—é–±–∏–º —Å–≤–æ–∏—Ö –∏–≥—Ä–æ–∫–æ–≤, —á—Ç–æ–±—ã –≤—ã–ø—É—Å–∫–∞—Ç—å –∏—Ö –≤ —Ç–∞–∫–æ–µ!",
	],
}

def pick_weather_message(description: str) -> str:
	"""–í–µ—Ä–Ω—ë—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ –∫—Ä–∞—Ç–∫–æ–º—É –æ–ø–∏—Å–∞–Ω–∏—é –ø–æ–≥–æ–¥—ã."""
	desc = description.lower()
	if any(w in desc for w in ["–≥—Ä–æ–∑", "–±—É—Ä", "—à—Ç–æ—Ä–º", "–≥—Ä–æ–∑–∞", "—É—Ä–∞–≥–∞–Ω", "–º–æ–ª–Ω–∏"]):
		cat = 'storm' if "–≥—Ä–æ–∑–∞" in desc or "–º–æ–ª–Ω–∏" in desc else 'extreme'
	elif any(w in desc for w in ["–ª–∏–≤–µ–Ω—å", "—É—Ä–∞–≥–∞–Ω", "—à—Ç–æ—Ä–º", "–∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å", "—É—Ä–∞–≥–∞–Ω"]):
		cat = 'extreme'
	elif any(w in desc for w in ["–¥—ã—Ä—É", "–≤–µ—Ç–µ—Ä", "–ø–æ—Ä—ã–≤–∏—Å—Ç", "–≤–µ—Ç—Ä"]):
		cat = 'wind'
	elif any(w in desc for w in ["—Å–Ω–µ–∂", "–º–µ—Ç–µ–ª", "—Å–Ω–µ–≥"]):
		cat = 'snow'
	elif any(w in desc for w in ["–¥–æ–∂–¥", "–º–æ—Ä–æ—Å—å", "–ª–∏–≤–µ–Ω—å"]):
		cat = 'rain'
	elif any(w in desc for w in ["–ø–∞—Å–º—É—Ä–Ω", "–æ–±–ª–∞—á", "—Ç—É–º–∞–Ω"]):
		cat = 'cloud'
	elif any(w in desc for w in ["—è—Å–Ω–æ", "—Å–æ–ª–Ω–µ—á", "—è—Å–Ω."]):
		cat = 'clear'
	else:
		cat = 'clear'
	import random as _rnd
	return _rnd.choice(WEATHER_MESSAGES[cat])

async def get_weather_forecast(target_iso_city: str, api_key: str, target_dt) -> Optional[str]:
	"""–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫—Ä–∞—Ç–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã —Å OpenWeather –¥–ª—è –≥–æ—Ä–æ–¥–∞ target_iso_city.

	–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞ "–û–ø–∏—Å–∞–Ω–∏–µ, t¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è t¬∞C), –≤–µ—Ç–µ—Ä –º/—Å" –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ/–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö.
	"""
	if not api_key:
		return None
	try:
		url = f"https://api.openweathermap.org/data/2.5/forecast?q={target_iso_city}&appid={api_key}&units=metric&lang=ru"
		async with aiohttp.ClientSession() as session:
			async with session.get(url, timeout=10) as resp:
				if resp.status != 200:
					return None
				data = await resp.json()
		if not data.get("list"):
			return None
		import math
		target_ts = int(target_dt.timestamp())
		best = min(data["list"], key=lambda e: abs(e["dt"] - target_ts))
		temp = best["main"]["temp"]
		feels = best["main"].get("feels_like", temp)
		desc = best["weather"][0]["description"].capitalize()
		wind = best["wind"]["speed"]
		return f"{desc}, üå° {temp:+.0f}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è {feels:+.0f}¬∞C), üí® {wind} –º/—Å"
	except Exception:
		return None



